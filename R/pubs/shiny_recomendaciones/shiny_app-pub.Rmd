---
title: "Publicar una Shinyapp 101"
author: Santiago Lator
date: "Fecha: `r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
    theme: lumen
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
abstract: "Algunas recomendaciones claves para principiantes como yo, reunidas en un solo lugar :)"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro

> Mi camino en R comenzó hace relativamente muy poco, pero desde el principio supe que queria meterme de lleno en el desarrollo de aplicaciones web combinando mi pasion por el lenguaje HTML, CSS y Javascript.
Asi es que, luego de realizar un curso intensivo en R, aproveché el trabajo final para empezar a meterme en el maravilloso mundo de Shiny.

## Primeros pasos

Mi primer recomendación es configurar el espacio de trabajo. Esto es, dejar todo listo para la publicacion de la app una vez que estemos satisfechos con nuestro trabajo. Doy por descontado que estamos trabajando con RStudio y su fantastico ecosistema.

### Cuenta en Shinyapps
Para esto, nos vamos a hacer una cuenta en [shinyapps.io](https://www.shinyapps.io/). Hay varios tipos de cuenta, con distintos objetivos y con sus precios correspondientes. Como siempre, la gente de RStudio ofrece una opcion gratuita con las caracteristicas suficientes para comenzar a probar.

El plan gratuito incluye 5 aplicaciones alojadas y hasta 25 horas de actividad mensuales (la app permanece idle hasta algun acceso). Esto ultimo es muy importante a la hora de subir la version final de nuestra aplicacion, ya que las horas se contabilizan por ciclo mensual y cuando se alcanza el limite en la cuenta gratuita deja de estar disponible para el acceso publico hasta el proximo ciclo. 

Para nuestras primeras aplicaciones, suponiento que no apuntamos a ambientes productivos, vamos a estar bien.

Por otro lado, si creemos que vamos a tener una gran afluencia de visitantes y no podemos invertir en una cuenta paga, una alternativa es generar una estructura de varias apps vinculadas entre si. Este concepto no lo experimente por mi mismo, pero conozco experiencias que lo llevaron adelante. Por supuesto, los tiempos de carga pueden resultar negativos en la experiencia de navegacion.

#### Vincular cuenta en RStudio

Una vez que tenemos una cuenta en Shinyapps tenemos que vincularla con el IDE. 

 

TOKEN + RStudio

### Creacion del proyecto

Es de extrema importancia iniciar el proceso de creacion de una aplicacion lo mas ordenado posible. Sobre todo para no tener que realizar cambios en la estructura principal.

Para esto, una *best practice* es crear un proyecto en RStudio por cada aplicacion.

![](C:/Lator Santiago/git/data_analytics/R/pubs/shiny_recomendaciones/new_project.gif)

Esto nos genera un directorio nuevo con 2 archivos, *app.R*: el archivo unificado de la aplicacion y *test.Rproj*: el archivo del proyecto.


![](C:/Lator Santiago/git/data_analytics/R/pubs/shiny_recomendaciones/new_project-files.PNG)


### Estructura de archivos: single o multiple file?

Como acabamos de ver, cuando creamos una nueva Shiny Web App como proyecto nos deja un workspace de un solo archivo para la aplicacion. 

Pero, si lo hacemos de manera independiente, desde *File > New File > Shiny Web App* nos permite elegir la estructura inicial de la aplicacion:

![](C:/Lator Santiago/git/data_analytics/R/pubs/shiny_recomendaciones/app_nueva-1.gif)

<br>

- **Single file** (*app.R*): Esta estructura es ideal para aplicaciones pequeñas, concentra en un mismo archivo las funciones de server y de interface.
<br>

##### app.R
  
<details><summary>Ver código</summary>
```{r eval=FALSE}
#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)

# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Old Faithful Geyser Data"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins",
                        "Number of bins:",
                        min = 1,
                        max = 50,
                        value = 30)
        ),

        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("distPlot")
        )
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {

    output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2]
        bins <- seq(min(x), max(x), length.out = input$bins + 1)

        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')
    })
}

# Run the application 
shinyApp(ui = ui, server = server)
```
</details>
<br>

- **Multiple file** (*ui.R/server.R*): En mi opinion, es la estructura indicada para aplicaciones medianas o grandes, principalmente a medida que aumenta el numero de lineas de codigo. Dividir la aplicación en varios archivos nos permite tener mayor visibilidad sobre el codigo, ayuda en el proceso de *debugging* y permite reutilizar el código para otro proyecto.
<br>

##### ui.R

<details><summary>Ver código</summary>
```{r eval=FALSE}
#
# This is the user-interface definition of a Shiny web application. You can
# run the application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)

# Define UI for application that draws a histogram
shinyUI(fluidPage(

    # Application title
    titlePanel("Old Faithful Geyser Data"),

    # Sidebar with a slider input for number of bins
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins",
                        "Number of bins:",
                        min = 1,
                        max = 50,
                        value = 30)
        ),

        # Show a plot of the generated distribution
        mainPanel(
            plotOutput("distPlot")
        )
    )
))
```
</details>

##### server.R

<details><summary>Ver código</summary>
```{r eval=FALSE}
#
# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)

# Define server logic required to draw a histogram
shinyServer(function(input, output) {

    output$distPlot <- renderPlot({

        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2]
        bins <- seq(min(x), max(x), length.out = input$bins + 1)

        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')

    })

})

```
</details>
<br>

### global.R: imprescindible

Es una muy buena practica centralizar bloques de codigo o lógicas que puedan ser reusadas  y evitar lineas redundantes. Para esto, podemos crear un script llamado `global.R` en el directorio raiz de la app.

Este script se ejecuta una sola vez, al lanzar la aplicacion. Pero lo mas importante es que cualquier objeto que se generen aqui quedan disponibles automaticamente tanto para `app.R` como para `ui.R` y `server.R`.

No es un requerimiento de una Shinyapp contar con esto, pero con este script podemos realizar mucho del pre-procesamiento y aumentar la velocidad de la app al reusar logicas o variables, en un ambiente global.

Es un excelente lugar para:

- cargar librerias > Solo se cargan una vez y estan disponibles durante la totalidad de la sesion
- funciones
- variables globales
- datasets
- fuentes

### Subdirectorios: /data y /www

Recomiendo crear un directorio `/data`en la raiz para ubicar nuestros datasets, archivos de datos **.Rdata** o archivos HTML . Estos datos los podemos cargar en `global.R` con, por ejemplo, `load(file = “./data/XXXX.RData”)` y ya queda disponible para toda la sesion :)

Tambien, podemos generar la carpeta `/www`para incorporar nuestros archivos CSS o imagenes, por ejemplo.

### Estructura final

Entonces, un ejemplo de una buena estructura para la publicacion, nos debería quedar asi:

```{r eval=FALSE}
test_app
├── ui.R
├── server.R
├── data
│   └── XXXX.Rdata
│   └── data.csv
└── www
    └── A.jpg
    └── ui.css    
```
<br>

![](C:/Lator Santiago/git/data_analytics/R/pubs/shiny_recomendaciones/new_project-files-2.PNG)

