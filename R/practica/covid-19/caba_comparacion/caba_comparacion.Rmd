---
title: "R Notebook"
output: html_notebook
---

### Librerias

```{r}
library(tidyverse)
library(here)
library(ggplot2)
library(sf)
library(lubridate)
#library(geojsonio)
#library(broom)
#devtools::install_github("yutannihilation/ggsflabel")
#library(ggsflabel)

here::here()
```

### Dataset

```{r}
#df <- read_csv("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/salud/casos-covid-19/casos_covid19.csv", encoding = "UTF-8")

df_covid19 <- read_csv(here("caba_comparacion", "dataset", "casos_covid19.csv"))

#df_barrios <- read.csv(here("caba_comparacion", "dataset", "barrios_comunas.csv"), sep = ";")

#df_barrios_geo <- geojson_read(here("caba_comparacion", "dataset", "barrios.geojson"),  what = "sp")
```

### Limpieza y transformacion

```{r}
df_covid19 <- df_covid19 %>% 
  mutate(
    fecha_clasificacion = dmy(gsub("\\:.*","", fecha_clasificacion))
  ) ## convierto a fecha el formato "ddMMyyyy:00:00:00.000000"

sum(duplicated(df_covid19$numero_de_caso)) ## Busco si existen casos duplicados

df_casos_confirmados <- df_covid19 %>% 
  filter(
    provincia == "CABA",
    is.na(fallecido),
    !is.na(comuna)
  ) %>% 
  count(
    comuna, name = "cantidad_casos"
    ) %>% 
  mutate(
    comuna = as.character(comuna)
  )

df_fallecidos <- df_covid19 %>% 
  filter(
    provincia == "CABA",
    !is.na(fallecido),
    !is.na(comuna)
  ) %>% 
  count(
    comuna, 
    name = "cantidad_fallecidos") %>% 
  mutate(
    comuna = as.character(comuna)
  )
```

### Plots

#### Mapa

```{r}
comunas <- st_read('https://bitsandbricks.github.io/data/CABA_comunas.geojson')

comunas <- comunas %>% 
  rename(
    "comuna" = comunas
  )

rivadavia <- st_read('https://bitsandbricks.github.io/data/avenida_rivadavia.geojson')

barrios_geo <- st_read(here("caba_comparacion", "dataset", "barrios.geojson")) 

nueva_columna <- c("Sur", "Norte", "Sur", "Sur", "Sur", "Norte", "Sur", "Sur", 
                   "Sur", "Norte", "Norte", "Norte", "Norte", "Norte", "Norte")


comunas <- left_join(comunas, df_casos_confirmados, by = "comuna")
comunas <- left_join(comunas, df_fallecidos, by = "comuna")
comunas <- mutate(comunas, ubicacion = nueva_columna)

comunas_sur <- filter(comunas, ubicacion == "Sur")
comunas_norte <- filter(comunas, ubicacion == "Norte")

mean(comunas_sur$cantidad_casos) / mean(comunas_norte$cantidad_casos)
mean(comunas_sur$cantidad_fallecidos) / mean(comunas_norte$cantidad_fallecidos)

# df_barrios_geo_fort <- tidy(df_barrios_geo)
# 
# lista_barrios <- df_barrios_geo$barrio
# 
# lista_id <- 1:48
# 
# df_barrios_id <- as.data.frame(cbind(lista_barrios,lista_id)) %>% 
#   rename(
#     "barrios" = lista_barrios,
#     "id" = lista_id
#   )
# 
# df_barrios_geo_fort <- left_join(df_barrios_geo_fort, df_barrios_id, by = "id")
```

#### Plot mapa

```{r}
ggplot(comunas) +
    geom_sf(aes(fill = ubicacion)) +
    geom_sf(data = rivadavia, color = "red")

comunas %>% 
  ggplot() + 
  geom_sf(aes(fill = cantidad_casos)) +
  geom_sf(data = rivadavia, color = "red") +
  #geom_sf_label(aes(label = comuna)) +
  scale_fill_distiller(palette = "Spectral")

comunas %>% 
  ggplot() + 
  geom_sf(aes(fill = cantidad_fallecidos)) +
  geom_sf(data = rivadavia, color = "red") +
  #geom_sf_label(aes(label = comuna)) +
  scale_fill_distiller(palette = "Spectral")

comunas %>% 
  filter(
    comuna == 1
  ) %>% 
  ggplot() + 
  geom_sf(aes(fill = cantidad_fallecidos))


barrios_geo %>% 
  ggplot() + 
  geom_sf(aes(fill = barrio)) #+
  #geom_sf(data = rivadavia, color = "red") +
  #geom_sf_label(aes(label = comuna)) +
  #scale_fill_distiller(palette = "Spectral")


barrios_geo %>% 
  filter(
    comuna == 15
  ) %>% 
ggplot() +
    geom_sf(aes(fill = barrio))

# df_barrios_geo_fort %>% 
#   filter(
#     id == 10 & id == 32
#   ) %>% 
#   ggplot() +
#   geom_polygon(aes(x = long, y = lat, group = barrios), fill="#69b3a2", color="white") +
#   theme_void() +
#   coord_map()
```
